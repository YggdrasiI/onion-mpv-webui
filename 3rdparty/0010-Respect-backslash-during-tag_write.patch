From 817f99c57070988dc37721dcfd462d5c2c14c7d0 Mon Sep 17 00:00:00 2001
From: Olaf Schulz <947069+YggdrasiI@users.noreply.github.com>
Date: Sat, 11 Jan 2025 12:29:42 +0100
Subject: [PATCH 10/12] Respect backslash during tag_write()

Before this change the tokens of a tag were splitted by \".
Now, "-quoted tokens will not break apart at \" substring.
---
 tools/otemplate/tags.c | 12 +++++++++---
 1 file changed, 9 insertions(+), 3 deletions(-)

diff --git a/tools/otemplate/tags.c b/tools/otemplate/tags.c
index c435a24..cfe6a87 100644
--- a/tools/otemplate/tags.c
+++ b/tools/otemplate/tags.c
@@ -89,6 +89,7 @@ void tag_write(parser_status * st, onion_block * b) {
   list *command = list_new((void *)tag_token_free);
 
   char mode = 0;                // 0 skip spaces, 1 in single var, 2 in quotes
+  char backslash = 0;           // for mode=2: 0 no escaping, 1 escaping
 
   // Split into elements for the list
   int i, li = 0;
@@ -101,6 +102,7 @@ void tag_write(parser_status * st, onion_block * b) {
       if (!isspace(c)) {
         if (c == '"') {
           mode = 2;
+          backslash = 0;
           li = i + 1;
         } else {
           mode = 1;
@@ -115,10 +117,14 @@ void tag_write(parser_status * st, onion_block * b) {
       }
       break;
     case 2:
-      if (c == '"') {
-        mode = 0;
-        list_add(command, tag_token_new(&data[li], i - li, T_STRING));
+      if (c == '"' && !backslash) {
+          mode = 0;
+          list_add(command, tag_token_new(&data[li], i - li, T_STRING));
       }
+      if (c == '\\')
+          backslash = 1-backslash;
+      else
+          backslash = 0;
       break;
     }
   }
-- 
2.25.1

