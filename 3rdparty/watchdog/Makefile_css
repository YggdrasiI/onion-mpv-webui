BIN=css-bundle-watchdog
SOURCES=css-bundle-watchdog.c argparse.c hashmap.c

# About folder for temp files:
# /tmp not on Ubuntu 20.04, /run/shm not on Manjaro
# $TMPDIR not always set
# Lets try /var/tmpâ€¦
TMPDIR:=/var/tmp

BUNDLE=$(TMPDIR)/onion-mpv-webui/webui.bundle.css
MIN=$(TMPDIR)/onion-mpv-webui/webui.min.css
#BUNDLE=/dev/shm/webui.bundle.css

# Name of current makefile
MAKEFILE:=$(lastword $(MAKEFILE_LIST))

FILES_TO_WATCH=../../webui-page/webui.css \
							 ../../webui-page

# Debug or Release
BUILD_TYPE?=Debug
CC?=gcc
RELEASE_FLAGS?=-std=c18 -O3 -D_NODEBUG
DEBUG_FLAGS?=-std=c18 -g


all:
	@(test -f .Release && make -f $(MAKEFILE) Release) \
			|| (test -f .Debug && make -f $(MAKEFILE) Debug) \
			|| make -f $(MAKEFILE) $(BUILD_TYPE)

Debug:
	@echo "Debug build"
	@rm .Release 2>/dev/null || true
	@BUILD_TYPE=Debug CCFLAGS="$(DEBUG_FLAGS)" make -f $(MAKEFILE) $(BIN) 

Release:
	@echo "Release build"
	@rm .Debug 2>/dev/null || true
	@BUILD_TYPE=Release CCFLAGS="$(RELEASE_FLAGS)" make -f $(MAKEFILE) $(BIN) 

# Dependency to force rebuild if build type changes
.$(BUILD_TYPE):
	@touch .$(BUILD_TYPE)

$(BIN): $(SOURCES) Makefile .$(BUILD_TYPE)
	$(CC) $(CCFLAGS) -o $(BIN) $(SOURCES)


# Run program
run: $(BIN)
	./$(BIN) -o "$(BUNDLE)" \
			$(FILES_TO_WATCH)


# Create bundle file and exit
oneshot: $(BIN)
	./$(BIN) -o "$(BUNDLE)" --oneshot \
			$(FILES_TO_WATCH)

# Compress bundle file and exit
min: $(BIN)
	./$(BIN)  --oneshot --uglifycss="--max-line-len 400" \
			$(FILES_TO_WATCH) \
			| sed -e "s/url('/url('..\/..\//g" -- \
			> "$(MIN)"


# Debugging targets
valgrind: $(BIN)
	valgrind ./$(BIN) -o "$(BUNDLE)" \
			$(FILES_TO_WATCH)

nemiver: $(BIN)
	nemiver ./$(BIN) -o "$(BUNDLE)" \
			$(FILES_TO_WATCH)
