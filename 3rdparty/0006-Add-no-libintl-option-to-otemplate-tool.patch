From 6857f68d5784da75bebdf828fcd1c2db39dc2102 Mon Sep 17 00:00:00 2001
From: Olaf Schulz <olaf_schulz@posteo.de>
Date: Mon, 8 Nov 2021 17:17:07 +0100
Subject: [PATCH 06/11] Add --no-libintl option to otemplate tool

In Bionic/Android environments is libintl not included.
This commit adds the option to avoid the dependency to libintl.

This disables the functionality of 'gettext'. If this is needed you
need to compile libintl with your Android SDK.
---
 tools/otemplate/otemplate.c | 14 ++++++++++++--
 1 file changed, 12 insertions(+), 2 deletions(-)

diff --git a/tools/otemplate/otemplate.c b/tools/otemplate/otemplate.c
index d7e968c..f33104c 100644
--- a/tools/otemplate/otemplate.c
+++ b/tools/otemplate/otemplate.c
@@ -39,6 +39,7 @@
 #include "../common/updateassets.h"
 
 list *plugin_search_path;
+int with_libintl = 1;
 
 int work(const char *infilename, const char *outfilename,
          onion_assets_file * assets);
@@ -82,6 +83,9 @@ int main(int argc, char **argv) {
       }
       assetfilename = argv[i];
       ONION_DEBUG("Assets file: %s", assetfilename);
+    } else if ((strcmp(argv[i], "--no-libintl") == 0)) {
+      ONION_DEBUG("Disable libintl dependency (gettext)");
+      with_libintl = 0;
     } else {
       if (infilename) {
         if (outfilename) {
@@ -150,6 +154,7 @@ void help(const char *msg) {
           "\n" "  --help                      Shows this help\n"
           "  --templatetagsdir|-t <dirname>  Adds that templatedir to known templatedirs. May be called several times.\n"
           "  --no-orig-lines|-n          Do not set the original lines on the generated .c file. With this off the \n"
+          "  --no-libintl                Disable internationalization by gettext. Useful on Bionic without libintl lib.\n"
           "                              error reporting refers to the C file, not the template.\n"
           "  --asset-file|-a             Write function definitions to an asset file. Defaults to assets.h\n"
           "  <infilename>                Input filename or '-' to use stdin.\n"
@@ -229,8 +234,13 @@ int work(const char *infilename, const char *outfilename,
 
   fprintf(status.out,
           "/** Autogenerated by otemplate v. 0.2.1 */\n"
-          "\n"
-          "#include <libintl.h>\n"
+          "\n");
+  if (with_libintl) {
+      fprintf(status.out, "#include <libintl.h>\n");
+  }else{
+      fprintf(status.out, "#define dgettext(DICT, KEY) (KEY)\n");
+  }
+  fprintf(status.out,
           "#include <stdio.h>\n"
           "#include <string.h>\n\n"
           "#include <onion/onion.h>\n"
-- 
2.47.1

